{"version":3,"sources":["../src/bitstuff2.js"],"names":[],"mappings":"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","file":"bitstuff2.js","sourcesContent":["// bitstuff2.js\n//\n// Copyright (c) 2016 Frank Lin (lin.xiaoe.f@gmail.com)\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nexport class BitStuff2 {\n\n  constructor(buffer) {\n    this.buffer_ = buffer;\n    this.lerc2Version_ = 0;\n    this.fp_ = 0;\n  }\n\n  setLerc2Version(lerc2Version) {\n    this.lerc2Version_ = lerc2Version;\n  }\n\n  setFilePosition(fp) {\n    this.fp_ = fp;\n  }\n\n  decode() {\n    var dataArray = new Uint8Array(0);\n\n    var numBitsByte = this.buffer_[this.fp_];\n    this.fp_++;\n\n    var bits67 = numBitsByte >> 6;\n    var n = (bits67 == 0) ? 4 : 3 - bits67;\n\n    var doLut = (numBitsByte & (1 << 5)) ? true : false;    // bit 5\n    numBitsByte &= 31;    // bits 0-4;\n\n    var numElements = this.decodeUInt_(n);\n    var numBits = numBitsByte;\n    if (!doLut) {\n      if (numBits > 0) {\n        if (this.lerc2Version_ >= 3) {\n          dataArray = this.unstuff_(numElements, numBits);\n        } else {\n          throw \"BitStuff2 decode failed because of unsupported lerc2 version (we are supporting version 3 and later\";\n        }\n      }\n    } else {\n      var nLutByte = this.buffer_[this.fp_];\n      this.fp_++;\n\n      var nLut = nLutByte - 1;\n      var tmpLutArray;\n      if (this.lerc2Version_ >= 3) {\n        tmpLutArray = this.unstuff_(nLut, numBits); // unstuff lut w/o the 0\n      } else {\n        throw \"BitStuff2 decode failed because of unsupported lerc2 version\";\n      }\n\n      var nBitsLut = 0;\n      while (nLut >> nBitsLut) {\n        nBitsLut++;\n      }\n\n      if (this.lerc2Version_ >= 3) {\n        dataArray = this.unstuff_(numElements, nBitsLut); // unstuff indexes\n      }\n\n      // replace indexes by values\n      var tmpLutArray2 = new Uint8Array(tmpLutArray.length + 1);\n      tmpLutArray2[0] = 0;\n      for (var i = 0; i < numElements; i++) {\n        tmpLutArray2[i + 1] = tmpLutArray[i];\n      }\n      for (var i = 0; i < numElements; i++) {\n        dataArray[i] = tmpLutArray2[dataArray[i]];\n      }\n    }\n\n    return { data: dataArray, filePosition: this.fp_ };\n  }\n\n  decodeUInt_(numFixedLengthValue) {\n    var numElements = 0;\n\n    if (numFixedLengthValue === 1) {\n      numElements = this.buffer_[this.fp_];\n    } else if (numFixedLengthValue === 2) {\n      var dv = new DataView(this.buffer_);\n      numElements = dv.getUint16(this.fp_);\n    } else if (numFixedLengthValue === 4) {\n      var dv = new DataView(this.buffer_);\n      numElements = dv.getUint32(this.fp_);\n    } else {\n      throw \"BitStuff2 DecodeUInt failed\";\n    }\n\n    this.fp_ += numFixedLengthValue;\n    return numElements;\n  }\n\n  unstuff_(numElements, numBits) {\n    var dataArray = new Uint8Array(numElements);\n\n    var numUInts = parseInt((numElements * numBits + 31) / 32);\n    var numBytes = numUInts * 4;\n\n    var bitStuffArray = new Uint8Array(numUInts);\n    bitStuffArray[numUInts - 1] = 0; // set last uint to 0\n\n    // copy the bytes from the incoming byte stream\n    var numBytesUsed = numBytes - this.numTailBytesNotNeeded_(numElements, numBits);\n    for (var i = 0; i < numBytesUsed; i++) {\n      bitStuffArray[i] = this.buffer_[this.fp_ + i];\n    }\n\n    // do the un-stuffing\n    var srcPos = 0;\n    var dstPos = 0;\n    var bitPos = 0;\n    var nb = 32 - numBits;\n\n    for (var i = 0; i < numElements; i++) {\n      if (nb - bitPos >= 0) {\n        dataArray[dstPos++] = (bitStuffArray[srcPos] << (nb - bitPos)) >> nb;\n        bitPos += numBits;\n        if (bitPos === 32) { // shift >= 32 is undefined\n          srcPos++;\n          bitPos = 0;\n        }\n      } else {\n        dataArray[dstPos] = bitStuffArray[srcPos++] >> bitPos;\n        dataArray[dstPos++] |= bitStuffArray[srcPos] << (64 - numBits - bitPos) >> nb;\n        bitPos -= nb;\n      }\n    }\n\n    this.fp_ += numBytesUsed;\n    return dataArray;\n  }\n\n  numTailBytesNotNeeded_(numElements, numBits) {\n    var numBitsTail = (numElements * numBits) & 31;\n    var numBytesTail = (numBitsTail + 7) >> 3;\n    return (numBytesTail > 0) ? 4 - numBytesTail : 0;\n  }\n}\n"]}